rules:
- id: tainted-cmd-from-http-request
  message: >-
    Detected input from a HTTPServletRequest going into a 'ProcessBuilder' or 'exec' command. This could
    lead to command injection if variables passed into the exec commands are not properly sanitized. Instead,
    avoid using these OS commands with user-supplied input, or, if you must use these commands, use a
    whitelist of specific values.
  languages: [java]
  severity: ERROR
  mode: taint
  pattern-sources:
    - patterns:
        - pattern: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $SOURCE,...) {
            ...
            }
        - metavariable-regex:
            metavariable: $TYPE
            regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
        - metavariable-regex:
            metavariable: $REQ
            regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
        - metavariable-pattern:
            metavariable: $ANNOTATION
            pattern-either:
            - pattern: RequestMapping
            - pattern: DeleteMapping
            - pattern: GetMapping
            - pattern: PatchMapping
            - pattern: PostMapping
            - pattern: PutMapping
        - focus-metavariable: $SOURCE
    - patterns:
        - pattern: |
            $RETURNTYPE $ENTRYPOINT(..., HttpServletRequest $REQ,...) {
            ...
            }
        - focus-metavariable: $REQ
  pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: |
                  new ProcessBuilder(...);
              - pattern: |
                    (ProcessBuilder $P).command(...);
              - pattern: |
                    (ProcessBuilder $P).environment().put(...);
              - pattern: |
                    (ProcessBuilder $P).directory(...);
              - patterns:
                  - pattern: (java.lang.Runtime $R).exec($CMD, ...);
                  - focus-metavariable: $CMD
              - pattern: |
                    (java.util.List<$TYPE> $ARGLIST).add(...);  
                    ...
                    (ProcessBuilder $PB).command($ARGLIST);
              - pattern: |
                    (java.util.List<$TYPE> $ARGLIST).add(...);  
                    ...
                    new ProcessBuilder($ARGLIST);
  metadata:
    category: security
    technology:
    - java
    cwe:
    - "CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')"
    owasp:
    - A01:2017 - Injection
    - A03:2021 - Injection
    references:
    - https://owasp.org/Top10/A03_2021-Injection
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
    - vuln
    likelihood: MEDIUM
    impact: MEDIUM
    confidence: MEDIUM
