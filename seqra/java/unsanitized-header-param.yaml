rules:
  - id: unsanitized-header-param
    message: "Unsanitized value in header that depends on user input allows a response-splitting vulnerability"
    metadata:
      shortDescription: "Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Request/Response Splitting')"
      cwe: CWE-113
    severity: ERROR
    patterns:
      - pattern-either:
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $SOURCE, ...) {
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ(...) $TYPE $SOURCE, ...) {
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ $TYPE $SOURCE, ...) {
              ...
            }
      - metavariable-regex:
          metavariable: $TYPE
          regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
      - metavariable-regex:
          metavariable: $REQ
          regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
      - focus-metavariable: $SOURCE
      - metavariable-pattern:
          metavariable: $ANNOTATION
          pattern-either:
          - pattern: RequestMapping
          - pattern: DeleteMapping
          - pattern: GetMapping
          - pattern: PatchMapping
          - pattern: PostMapping
          - pattern: PutMapping

      - pattern: |
          (HttpServletResponse $RESPONSE).$HEADER_SET("...", $SOURCE);
      - metavariable-regex:
          metavariable: $HEADER_SET
          regex: ^(addHeader|setHeader)
    languages:
      - java
