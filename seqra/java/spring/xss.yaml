rules:
  - id: xss
    languages:
      - java
    severity: ERROR
    message: Controller returns an untrusted unvalidated data
    metadata:
      cwe: CWE-79
      license: MIT
      shortDescription: Controller returns an untrusted unvalidated data
    patterns:
    - pattern-either:
      - patterns:
        - pattern: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $PARAM,...) {
              ...
              return $PARAM;
              ...
            }
        - pattern-not-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $PARAM,...) {
              ...
              $RESPONSE = HtmlUtils.htmlEscape($PARAM);
              ...
              return $RESPONSE;
              ...
            }
        - metavariable-regex:
            metavariable: $TYPE
            regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
        - metavariable-regex:
            metavariable: $REQ
            regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
        - metavariable-pattern:
            metavariable: $ANNOTATION
            pattern-either:
            - pattern: RequestMapping
            - pattern: DeleteMapping
            - pattern: GetMapping
            - pattern: PatchMapping
            - pattern: PostMapping
            - pattern: PutMapping
      - patterns:
          - patterns:
            - pattern: |
                MultipartFile $RESPONSE = $SOURCE.$MD();
            - pattern-not-inside: |
                MultipartFile $FILE = $SOURCE.$MD();
                ...
                $RESPONSE = Filenames.toSimpleFileName($FILE);
          - patterns:
            - pattern-either:
              - pattern-inside: |
                  @$ANNOTATION(...)
                  $RETURNTYPE $METHOD(..., $TYPE $PARAM,...) {
                    ...
                    return $RESPONSE;
                    ...
                  }
            - metavariable-regex:
                metavariable: $TYPE
                regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
            - metavariable-regex:
                metavariable: $REQ
                regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
            - metavariable-pattern:
                metavariable: $ANNOTATION
                pattern-either:
                - pattern: RequestMapping
                - pattern: DeleteMapping
                - pattern: GetMapping
                - pattern: PatchMapping
                - pattern: PostMapping
                - pattern: PutMapping
