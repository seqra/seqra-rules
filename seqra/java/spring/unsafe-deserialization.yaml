rules:
  - id: unsafe-deserialization
    languages:
      - java
    severity: ERROR
    message: |
        Found object deserialization using ObjectInputStream with user-controlled input.
        Deserialization of entire Java objects is dangerous because malicious actors can
        create Java object streams with unintended consequences.
    metadata:
      cwe: CWE-502
      owasp:
      - A08:2017 - Insecure Deserialization
      - A08:2021 - Software and Data Integrity Failures
      category: security
      technology:
      - java
      cwe2022-top25: true
      cwe2021-top25: true
      likelihood: LOW
      impact: HIGH
      confidence: MEDIUM
      shortDescription: Untrusted object deserialization using ObjectInputStream
    patterns:
    - pattern: $OIS = new ObjectInputStream($SOURCE);
    - patterns:
      - pattern-either:
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $SOURCE,...) {
              ...
              return $SINK;
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ(...) $TYPE $SOURCE,...) {
              ...
              return $SINK;
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ $TYPE $SOURCE,...) {
              ...
              return $SINK;
              ...
            }
      - metavariable-regex:
          metavariable: $TYPE
          regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
      - metavariable-regex:
          metavariable: $REQ
          regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
      - metavariable-pattern:
          metavariable: $ANNOTATION
          pattern-either:
          - pattern: RequestMapping
          - pattern: DeleteMapping
          - pattern: GetMapping
          - pattern: PatchMapping
          - pattern: PostMapping
          - pattern: PutMapping
