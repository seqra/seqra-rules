rules:
  - id: sax-parser
    languages:
      - java
    severity: ERROR
    message: Untrusted input is parsed as an XML with safety flags disabled
    metadata:
      cwe: CWE-611
      license: MIT
      shortDescription: XML parsing of an untrusted input
    patterns:
    - pattern-not-inside: |
        $RETURNTYPE $METHOD(...) {
          ...
          $SF.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);
          ...
        }
    - pattern-not-inside: |
        $RETURNTYPE $METHOD(...) {
          ...
          $SF.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
          ...
        }
    - pattern-either:
      - pattern-not-inside: |
          $RETURNTYPE $METHOD(...) {
            ...
            $SF.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
            ...
          }
      - pattern-not-inside: |
          $RETURNTYPE $METHOD(...) {
            ...
            $SF.setFeature("http://xml.org/sax/features/external-general-entities", false);
            ...
          }
    - pattern-either:
      - patterns:
        - pattern-inside: |
            $SF = SAXParserFactory.newInstance();
            ...
        - pattern: $SF.newSAXParser().parse($SOURCE);
      - patterns:
        - pattern-inside: |
            $SF = new SAXReader(...);
            ...
        - pattern: $SF.read($SOURCE);
    - patterns:
      - pattern-either:
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., $TYPE $SOURCE, ...) {
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ(...) $TYPE $SOURCE, ...) {
              ...
            }
        - pattern-inside: |
            @$ANNOTATION(...)
            $RETURNTYPE $METHOD(..., @$REQ $TYPE $SOURCE, ...) {
              ...
            }
      - metavariable-regex:
          metavariable: $TYPE
          regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean))
      - metavariable-regex:
          metavariable: $REQ
          regex: (RequestBody|PathVariable|RequestParam|RequestHeader|CookieValue|ModelAttribute)
      - metavariable-pattern:
          metavariable: $ANNOTATION
          pattern-either:
          - pattern: RequestMapping
          - pattern: DeleteMapping
          - pattern: GetMapping
          - pattern: PatchMapping
          - pattern: PostMapping
          - pattern: PutMapping
