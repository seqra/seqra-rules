rules:
  - id: java-xpath-injection-sinks
    options:
      lib: true
    severity: NOTE
    message: XPath query contains user-manipulated data
    metadata:
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/lang/security/audit/tainted-xpath-from-http-request.yaml
    languages:
      - java
    pattern-either:
      - pattern: |
          (javax.xml.xpath.XPath $XP).evaluate($UNTRUSTED, ...)
      - pattern: |
          (javax.xml.xpath.XPath $XP).evaluateExpression($UNTRUSTED, ...)
      - pattern: |
          (javax.xml.xpath.XPath $XP).compile($UNTRUSTED, ...).evaluate(...)
      - pattern: |
          (javax.xml.xpath.XPath $XP).compile(...).evaluate($UNTRUSTED, ...)

  - id: java-mongodb-nosql-injection
    options:
      lib: true
    severity: NOTE
    message: >-
      User-controled data passed into a NoSQL query using the 'where' evaluation operator.
    metadata:
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/mongodb/security/injection/audit/mongodb-nosqli.yaml
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: (com.mongodb.BasicDBObject $QUERY).put("$where", $INPUT);
          - pattern: |
              (java.util.Map $MAP).put("$where", $INPUT);
              ...
              (com.mongodb.BasicDBObject $QUERY).putAll($MAP);
          - pattern: (com.mongodb.BasicDBObject $QUERY).append("$where", $INPUT);
          - pattern: new com.mongodb.BasicDBObject("$where", $INPUT);
          - pattern: |
              (java.util.Map $MAP).put("$where", $INPUT);
              ...
              new com.mongodb.BasicDBObject($MAP);
          - pattern: |
              (java.util.Map $MAP).put("$where", $INPUT);
              ...
              String $JSON = new JSONObject($MAP).toString();
              ...
              (com.mongodb.BasicDBObject $QUERY).parse((String $JSON));
          - pattern: com.mongodb.BasicDBObjectBuilder.start().add("$where", $INPUT);
          - pattern: com.mongodb.BasicDBObjectBuilder.start().append("$where", $INPUT);
          - pattern: com.mongodb.BasicDBObjectBuilder.start("$where", $INPUT);
          - pattern: |
              (java.util.Map $MAP).put("$where", $INPUT);
              ...
              com.mongodb.BasicDBObjectBuilder.start($MAP);
