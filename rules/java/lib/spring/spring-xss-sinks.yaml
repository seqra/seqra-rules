rules:
  - id: spring-xss-sink
    options:
      lib: true
    severity: NOTE
    message: Direct write of unvalidated user input into response
    metadata:
      provenance:
        - https://github.com/semgrep/semgrep-rules/blob/develop/java/spring/security/injection/tainted-html-string.yaml
        - https://github.com/semgrep/semgrep-rules/blob/develop/java/lang/security/audit/xss/no-direct-response-writer.yaml
    languages:
      - java
    mode: taint
    pattern-sanitizers:
      - patterns:
        - pattern-either:
            - pattern: Encode.forHtml(..., $UNTRUSTED, ...)
            - pattern: (PolicyFactory $POLICY).sanitize(..., $UNTRUSTED, ...)
            - pattern: (AntiSamy $AS).scan(..., $UNTRUSTED, ...)
            - pattern: JSoup.clean(..., $UNTRUSTED, ...)
            - pattern: HtmlUtils.htmlEscape(..., $UNTRUSTED, ...)
        - focus-metavariable: $UNTRUSTED
    pattern-sinks:
      - patterns:
        - pattern-either:
          - patterns:
            - pattern: |
                @$ANNOTATION(...)
                $RETURNTYPE $METHOD(...) {
                  ...
                  return $UNTRUSTED;
                  ...
                }
            - metavariable-pattern:
                metavariable: $ANNOTATION
                patterns:
                  - pattern-either:
                      - pattern: RequestMapping
                      - pattern: DeleteMapping
                      - pattern: GetMapping
                      - pattern: PatchMapping
                      - pattern: PostMapping
                      - pattern: PutMapping
          - pattern: (HttpServletResponse $RESPONSE).sendError($CODE, $UNTRUSTED)
          - pattern: |
              (HttpServletResponse $RESPONSE).getWriter(...).$WRITE(..., $UNTRUSTED, ...)
          - pattern: |
              (HttpServletResponse $RESPONSE).getOutputStream(...).$WRITE(..., $UNTRUSTED, ...)
          - pattern: |
              (HttpServletResponse $RESPONSE).sendError($CODE, $UNTRUSTED)
          - pattern: |
              (javax.servlet.ServletOutputStream $WRITER).$WRITE(..., $UNTRUSTED, ...)
          - pattern: |
              (ServletOutputStream $WRITER).$WRITE(..., $UNTRUSTED, ...)
        - focus-metavariable: $UNTRUSTED
