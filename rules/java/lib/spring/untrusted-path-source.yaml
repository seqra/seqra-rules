rules:
  - id: spring-untrusted-path-source
    options:
      lib: true
    severity: NOTE
    message: Untrusted data flows from here
    languages:
      - java
    patterns:
      - pattern-either:
          - patterns:
              - pattern-either:
                    - pattern: |
                        @$ANNOTATION($URL)
                        $RETURNTYPE $METHODNAME(..., @PathVariable $TYPE $UNTRUSTED,...) {
                          ...
                        }
                    - patterns:
                        - pattern: |
                            @$ANNOTATION(...)
                            $RETURNTYPE $METHODNAME(..., $TYPE $UNTRUSTED,...) {
                              ...
                            }
                        - pattern-not: |
                            @$ANNOTATION(...)
                            $RETURNTYPE $METHODNAME(..., @PathVariable $TYPE $UNTRUSTED,...) {
                              ...
                            }
              - metavariable-regex:
                  metavariable: $URL
                  regex: .*\*.*
              - metavariable-regex:
                  metavariable: $TYPE
                  regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean|BindingResult|HttpMethod|java.util.TimeZone|java.util.Locale|java.util.ZoneId))
              - metavariable-pattern:
                  metavariable: $ANNOTATION
                  patterns:
                    - pattern-either:
                        - pattern: RequestMapping
                        - pattern: DeleteMapping
                        - pattern: GetMapping
                        - pattern: PatchMapping
                        - pattern: PostMapping
                        - pattern: PutMapping
          - pattern: |
              $UNTRUSTED = (MessageBodyReader $READER).readFrom(...);
          - pattern: |
              Cookie $COOKIE = org.springframework.web.util.WebUtils.getCookie(...);
              ...
              $UNTRUSTED = $COOKIE.getValue();
