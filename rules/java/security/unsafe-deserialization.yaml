rules:
  - id: unsafe-object-mapper-in-servlet-app
    severity: ERROR
    message: >-
      Found object deserialization using ObjectInputStream with user-controlled input.
      Deserialization of entire Java objects is dangerous because malicious actors can
      create Java object streams with unintended consequences.
    metadata:
      cwe: CWE-502
      short-description: Deserialization of untrusted data with ObjectMapper
      references:
        - https://find-sec-bugs.github.io/bugs.htm#OBJECT_DESERIALIZATION
      provenance: https://find-sec-bugs.github.io/bugs.htm#OBJECT_DESERIALIZATION
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/generic/servlet-untrusted-data-source.yaml#java-servlet-untrusted-data-source
          as: untrusted-data
        - rule: java-unsafe-object-mapper-sink
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$UNTRUSTED'

  - id: unsafe-object-mapper-in-spring-app
    severity: ERROR
    message: >-
      Found object deserialization using ObjectInputStream with user-controlled input.
      Deserialization of entire Java objects is dangerous because malicious actors can
      create Java object streams with unintended consequences.
    metadata:
      cwe: CWE-502
      short-description: Deserialization of untrusted data with ObjectMapper
      references:
        - https://find-sec-bugs.github.io/bugs.htm#OBJECT_DESERIALIZATION
      provenance: https://find-sec-bugs.github.io/bugs.htm#OBJECT_DESERIALIZATION
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/spring/untrusted-data-source.yaml#spring-untrusted-data-source
          as: untrusted-data
        - rule: java-unsafe-object-mapper-sink
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$UNTRUSTED'

  - id: java-unsafe-object-mapper-sink
    options:
      lib: true
    severity: NOTE
    message: Deserialization of untrusted data with ObjectMapper
    metadata:
      provenance: https://find-sec-bugs.github.io/bugs.htm#OBJECT_DESERIALIZATION
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: new ObjectInputStream($UNTRUSTED);

  - id: insecure-jms-deserialization
    severity: WARNING
    message: >-
      JMS Object messages depend on Java Serialization for marshalling/unmarshalling
      of the message payload when ObjectMessage.getObject() is called.
      Deserialization of untrusted data can lead to security flaws; a remote attacker
      could via a crafted JMS ObjectMessage to execute
      arbitrary code with the permissions of the application listening/consuming JMS
      Messages.
      In this case, the JMS MessageListener consume an ObjectMessage type received inside
      the onMessage method, which may lead to arbitrary code execution when calling
      the $Y.getObject method.
    metadata:
      cwe:
        - CWE-502
      short-description: Deserialization of untrusted data
      references:
        - https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities-wp.pdf
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/lang/security/insecure-jms-deserialization.yaml
    languages:
      - java
    patterns:
      - pattern-inside: |
          public class $JMS_LISTENER implements MessageListener {
            ...
            public $RET onMessage(Message $JMS_MSG) {
                ...
            }
          }

      - pattern: $X = $Y.getObject(...);

  - id: unsafe-jackson-deserialization-in-servlet-app
    severity: ERROR
    message: Found Jackson deserialization with user-controlled input.
    metadata:
      cwe:
        - CWE-502
      short-description: Unsafe Jackson deserialization with user-controlled input
      references:
        - https://swapneildash.medium.com/understanding-insecure-implementation-of-jackson-deserialization-7b3d409d2038
        - https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062
        - https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/
      provenance: https://semgrep.dev/r/gitlab.java_deserialization_rule-JacksonUnsafeDeserialization
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/generic/servlet-untrusted-data-source.yaml#java-servlet-untrusted-data-source
          as: untrusted-data
        - rule: java/lib/generic/unsafe-deserialization-sinks.yaml#jackson-unsafe-deserialization
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$JSON'

  - id: unsafe-jackson-deserialization-in-spring-app
    severity: ERROR
    message: Found Jackson deserialization with user-controlled input.
    metadata:
      cwe:
        - CWE-502
      short-description: Unsafe Jackson deserialization with user-controlled input
      references:
        - https://swapneildash.medium.com/understanding-insecure-implementation-of-jackson-deserialization-7b3d409d2038
        - https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062
        - https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/
      provenance: https://semgrep.dev/r/gitlab.java_deserialization_rule-JacksonUnsafeDeserialization
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/spring/untrusted-data-source.yaml#spring-untrusted-data-source
          as: untrusted-data
        - rule: java/lib/generic/unsafe-deserialization-sinks.yaml#jackson-unsafe-deserialization
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$JSON'

  - id: server-dangerous-object-deserialization
    severity: ERROR
    message: >-
      Using an arbitrary object ('$PARAMTYPE $PARAM') with Java RMI is an insecure deserialization
      vulnerability. This object can be manipulated by a malicious actor allowing them to execute
      code on your system. Instead, use an integer ID to look up your object, or consider alternative
      serialization schemes such as JSON.
    metadata:
      cwe:
        - CWE-502
      short-description: Insecure deserelization in Java RMI
      references:
        - https://frohoff.github.io/appseccali-marshalling-pickles/
        - https://book.hacktricks.xyz/network-services-pentesting/1099-pentesting-java-rmi
        - https://youtu.be/t_aw1mDNhzI
        - https://github.com/qtc-de/remote-method-guesser
        - https://github.com/openjdk/jdk/blob/master/src/java.rmi/share/classes/sun/rmi/server/UnicastRef.java#L303C4-L331
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/rmi/security/server-dangerous-object-deserialization.yaml
    languages:
      - java
    patterns:
      - pattern: |
          interface $INTERFACE extends Remote {
            $RETURNTYPE $METHOD($PARAMTYPE $PARAM) throws RemoteException;
          }
      - metavariable-regex:
          metavariable: $PARAMTYPE
          regex: ^(?!(Integer|Long|Float|Double|Char|Boolean|int|long|float|double|char|boolean|String))

  - id: java-servlet-unsafe-snake-yaml-deserialization
    severity: ERROR
    message: >-
      Insecure deserialization. Used SnakeYAML org.yaml.snakeyaml.Yaml() constructor on user-manipulater yaml data.
    metadata:
      cwe:
        - CWE-502
      short-description: Insecure deserialization of untrusted YAML data
      references:
        - https://securitylab.github.com/research/swagger-yaml-parser-vulnerability/#snakeyaml-deserialization-vulnerability
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/lang/security/use-snakeyaml-constructor.yaml
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/generic/servlet-untrusted-data-source.yaml#java-servlet-untrusted-data-source
          as: untrusted-data
        - rule: java/lib/generic/unsafe-deserialization-sinks.yaml#yaml-unsafe-deserialization-sink
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$YAML'

  - id: spring-unsafe-snake-yaml-deserialization
    severity: ERROR
    message: >-
      Insecure deserialization. Used SnakeYAML org.yaml.snakeyaml.Yaml() constructor on user-manipulater yaml data.
    metadata:
      cwe:
        - CWE-502
      short-description: Insecure deserialization of untrusted YAML data
      references:
        - https://securitylab.github.com/research/swagger-yaml-parser-vulnerability/#snakeyaml-deserialization-vulnerability
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/lang/security/use-snakeyaml-constructor.yaml
    languages:
      - java
    mode: join
    join:
      refs:
        - rule: java/lib/spring/untrusted-data-source.yaml#spring-untrusted-data-source
          as: untrusted-data
        - rule: java/lib/generic/unsafe-deserialization-sinks.yaml#yaml-unsafe-deserialization-sink
          as: sink
      on:
        - 'untrusted-data.$UNTRUSTED -> sink.$YAML'

  - id: insecure-resteasy-deserialization
    severity: WARNING
    message: >-
      When a Restful webservice endpoint is configured to use wildcard mediaType {*/*} as a value for the
      @Consumes annotation, an attacker could abuse the SerializableProvider by sending a HTTP Request
      with a Content-Type of application/x-java-serialized-object. The body of that request would be processed
      by the SerializationProvider and could contain a malicious payload, which may lead to arbitrary code
      execution when calling the $Y.getObject method.
    metadata:
      cwe:
        - CWE-502
      short-description: Insecure deserialization of request
      references:
        - https://access.redhat.com/blogs/766093/posts/3162112
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/jax-rs/security/insecure-resteasy.yaml
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: |
              @Consumes($PARAM)
              class $C { ... }
          - pattern: |
              @Consumes($PARAM)
              $RETURNTYPE $METHOD(...) { ... }
      - metavariable-pattern:
          metavariable: $PARAM
          pattern-either:
            - pattern: |
                "application/x-java-serialized-object"
            - pattern: |
                "*/*"
            - pattern: |
                MediaType.WILDCARD_TYPE

  - id: default-resteasy-provider-abuse
    severity: WARNING
    message: >-
      When a Restful webservice endpoint isn't configured with a @Consumes annotation, an attacker could
      abuse the SerializableProvider by sending a HTTP Request with a Content-Type of application/x-java-serialized-object. The
      body of that request would be processed by the SerializationProvider and could contain a malicious
      payload, which may lead to arbitrary code execution. Instead, add a @Consumes annotation to the function
      or class.
    metadata:
      cwe:
        - CWE-502
      short-description: Insecure deserialization of request
      references:
        - https://access.redhat.com/blogs/766093/posts/3162112
      provenance: https://github.com/semgrep/semgrep-rules/blob/develop/java/jax-rs/security/insecure-resteasy.yaml
    languages:
      - java
    patterns:
      - pattern: |
          @Path("...")
          public $RETURNTYPE $METHOD(...) { ...}
      - pattern-not-inside: |
          @GET
          public $RETURNTYPE $METHOD(...) { ...}
      - pattern-not-inside: |
          @Path("...")
          @Consumes(...)
          public $RETURNTYPE $METHOD(...) { ...}
      - pattern-not-inside: |
          @Consumes(...)
          public class $CLASSNAME { ... }


  - id: apache-rpc-enabled-extensions
    severity: WARNING
    message: |
      Enabling extensions in Apache XML RPC server or client can lead to deserialization
      vulnerability which would allow an attacker to execute arbitrary code.
    metadata:
      cwe: CWE-502
      short-description: Deserialization of untrusted data with arbitrary code execution
      provenance: https://semgrep.dev/r/gitlab.find_sec_bugs.RPC_ENABLED_EXTENSIONS-1
    languages:
      - java
    patterns:
      - pattern-either:
          - patterns:
              - pattern-inside: |
                  XmlRpcServerConfigImpl $VAR = new org.apache.xmlrpc.server.XmlRpcServerConfigImpl();
                  ...
              - pattern: $VAR.setEnabledForExtensions(true);
          - patterns:
              - pattern-inside: |
                  XmlRpcClientConfigImpl $VAR = new org.apache.xmlrpc.client.XmlRpcClientConfigImpl();
                  ...
              - pattern: $VAR.setEnabledForExtensions(true);
